/*!
 * Oscy.js
 * -------
 * Just another instrument by Oscillator on Web Audio API
 * 
 * @version 0.1.1 (2014/08/12)
 * @author mach3 <http://github.com/mach3>
 * @license MIT
 * @require jquery#1, jquery-easing
 */
!function(a,b){var c={};if(b.AudioContext=b.AudioContext||b.webkitAudioContext||null,!b.AudioContext)throw new Error("AudioContext is not supported");b.AudioContext.prototype.createGain=b.AudioContext.prototype.createGain||b.AudioContext.prototype.createGainNode,c.context=new AudioContext;var d={extend:function(){var b=d.toArray(arguments).map(function(b){return a.isFunction(b)?b.prototype:b});return a.extend.apply(null,b)},toArray:function(a){return Array.prototype.slice.call(a)},bindObject:function(b,c){c.forEach(function(c){a.isFunction(b[c])&&(b[c]=b[c].bind(b))})},last:function(a){return a[a.length-1]},columns:function(a,b){var c=[];return d.toArray(a).forEach(function(a){c.push(a[b])}),c},format:function(){var a=d.toArray(arguments);return a.shift().replace(/%s/g,function(){return a.length?a.shift():""})}};c.Config=function(){},d.extend(c.Config,{defaults:null,options:null,config:function(){var b,c,e;switch(b=this,c=d.toArray(arguments),"object"!==a.type(this.options)&&(this.options={},this.defaults&&this.config(this.defaults)),e=!1,a.type(c[0])){case"string":return c.length<2?this.options[c[0]]:(e=c[1]!==this.options[c[0]],this.options[c[0]]=c[1],e&&a.isFunction(this.onChange)&&this.onChange(c[0],c[1]),this);case"object":return a.each(c[0],function(a,c){b.config(a,c)}),this;case"undefined":return this.options}return this}}),c.Sound=function(){this._construct.apply(this,arguments)},d.extend(c.Sound,c.Config,{defaults:{autoplay:!1,type:"sine",frequency:440,frequencyMax:880,frequencyMin:220,detune:0,detuneMin:-500,detuneMax:500,gain:0},id:null,initialized:!1,context:null,options:null,osc:null,gain:null,timer:null,_construct:function(a,b){this.id=a,this.config(b),this.context=c.context,this.osc=this.context.createOscillator(),this.gain=this.context.createGain(),this.osc.connect(this.gain),this.gain.connect(this.context.destination),this.update(),this.config("autoplay")&&this.start(),this.initialized=!0},start:function(){return this.osc.start(0),this},stop:function(){return this.osc.stop(0),this},onChange:function(a,b){this.initialized&&this.update(a,b)},update:function(b,c){var d=this;if(!arguments.length)return a.each(this.config(),function(a,b){d.update(a,b)}),this;switch(b){case"frequency":case"detune":this.osc[b].value=c;break;case"type":this.osc[b]=c;break;case"gain":this.gain.gain.value=c}return this},fade:function(b,c,d,e){var f,g,h,i,j,k,l;return f=a.Deferred(),this.timer?this:(c=a.easing[c]||a.easing.swing,d=d||1e3,e=a.isFunction(e)?e:a.noop,g=this,h=0,i=10,j={},k={},a.each(b,function(a,b){j[a]=g.config(a),k[a]=b-j[a]}),l=function(){var l;return h>=d?(clearInterval(g.timer),g.timer=null,e.call(g),void f.resolve(g)):(h+=i,l=c(null,h,0,1,d),void a.each(b,function(a){g.config(a,j[a]+k[a]*l)}))},this.timer=setInterval(l,i),f)},destruct:function(){this.stop(),this.gain.disconnect(0),this.osc.disconnect(0)}}),c.RippleBase=function(){this._construct.apply(this,arguments)},d.extend(c.RippleBase,c.Config,{defaults:{panel:null,baseColor:"#000",size:120},base:null,_construct:function(b){this.config(b),this.base=a("<div>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","background-color":this.config("baseColor"),"z-index":1,overflow:"hidden"}),this.base.insertBefore(this.config("panel"))},getColor:function(a){var b=parseInt(360*a.x,10);return"hsl("+b+", 100%, 50%)"},show:function(b){var c,d,e,f;return c=this.options,d=a("<i>"),e=function(b){var c=a(b.target);c.remove(),c.off(e)},f=this.getColor(b),d.css({position:"absolute",display:"block",left:b.offsetX,top:b.offsetY,"border-style":"solid","border-width":3,"border-color":f,"border-radius":"100%",width:1,height:1,transition:"all 2s ease 0"}).on("transitionend",e).appendTo(this.base),setTimeout(function(){d.css({left:b.offsetX-c.size/2,top:b.offsetY-c.size/2,"border-color":c.baseColor,width:c.size,height:c.size})},10),d}}),c.Composer=function(){this._construct.apply(this,arguments)},d.extend(c.Composer,c.Config,{defaults:{ripple:!0,rippleBaseColor:"#000",type:"sine",effect:"easeInOutBounce",backgroundImage:["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWgAAAAICAYAAADUZmU7AAABMklEQVRoQ+","1a7QqDMAyssL3/A2/gBzK14tJerqwz3A9BXZKq6d2Sa4cxpTE9UtqO5+F8uY9cI7bn2D/0fc+v9Tleh/","PlnnWN2LaMxY67J/cuCSUnR48EM0lifOd39cKXgRyZoYxW0OfY0VtC2fl38kNn7IDEQmzzZx5E0PXp9n","/mdYyjPxILsb2asn0gjMLOsgdjiaCr6i3wq5q1GhML9a1HLIO6EvkjqERsRdBb9VxKwf3Tu05lEXRly+","THkd16lSYaM64q6NA9sCro0OkVQZuaVct/YIZkGV8RdGgEi6BDp1cELYL+3j+h0kJDEUoadGUfL4IWQR","sSCANhxpdcgpIGLQ36chsA2ap0WEUSQYugRdCeLT3/Io9I4giNYBF06PRK4pDEIYnDt6m25cquv3KfAP","kWqGScetsTAAAAAElFTkSuQmCC"].join("")},panel:null,rippleBase:null,sound:[],_construct:function(b,e){d.bindObject(this,["onStart","onMove","onStop"]),this.config(e),this.panel=a(b).css({position:"absolute",left:0,top:0,width:"100%",height:"100%","z-index":2,"-webkit-user-select":"none","background-image":d.format("url(%s)",this.config("backgroundImage")),"background-repeat":"no-repeat","background-size":"100% 8px","background-position":"left center",opacity:".3"}),this.config("ripple")&&(this.rippleBase=new c.RippleBase({panel:this.panel,baseColor:this.config("rippleBaseColor"),size:this.panel.width()/3})),this.panel.on({"mousedown touchstart":this.onStart,"mouseup touchend":this.onStop,"mousemove touchmove":this.onMove})},touches:function(b){var c,d,e,f;return b=b.originalEvent||b,c=[],d=this.panel.offset(),e={width:this.panel.outerWidth(),height:this.panel.outerHeight()},f=function(a,b,d){c.push({id:a,offsetX:b,offsetY:d,x:b/e.width,y:d/e.height})},/^touch/.test(b.type)?a.each(b.changedTouches,function(a,b){f(b.identifier,b.pageX-d.left,b.pageY-d.top)}):f(null,b.offsetX,b.offsetY),c},getSoundById:function(a){var b=this.sound.filter(function(b){return b.id===a});return b.length?b[0]:null},remove:function(a){var b,c;return b=this,c=0,this.sound.forEach(function(d,e){a.indexOf(d.id)<0||(d.fade({gain:0},b.config("effect"),3e3).done(d.destruct.bind(d)),b.sound.splice(e),c+=1)}),c},removeGarbage:function(a){return a=a.originalEvent||a,a.touches&&!a.touches.length&&this.sound.length?this.remove(d.columns(this.sound,"id")):0},updateSound:function(a,b){var c,d;return c=a.config(),d=function(a,b,c){return a+(b-a)*c},a.config({detune:1-d(c.detuneMin,c.detuneMax,b.y),frequency:d(c.frequencyMin,c.frequencyMax,b.x)}),this},showRipple:function(a){this.config("ripple")&&this.rippleBase.show(a)},onStart:function(a){var b=this;a.preventDefault(),this.touches(a).forEach(function(a){var d=new c.Sound(a.id,{gain:.5,type:b.config("type")});b.updateSound(d,a),b.sound.push(d),d.start(),b.showRipple(a)})},onMove:function(a){var b=this;a.preventDefault(),this.touches(a).forEach(function(a){var c;(c=b.getSoundById(a.id))&&(b.updateSound(c,a),b.showRipple(a))})},onStop:function(a){a.preventDefault(),this.remove(d.columns(this.touches(a),"id")),this.removeGarbage(a)}}),b.Oscy=c.Composer}(jQuery,this);